Antigravityç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šgenerator.pyã®æœ€çµ‚ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
ã‚¿ã‚¹ã‚¯å:
Final Refactoring of generator.py for DRY Principle and Modern Asset Handling
ã‚¿ã‚¹ã‚¯èª¬æ˜ (Instructions):
You are a Principal Software Architect performing a final code review. Your previous implementation of the separated pipelines was excellent. However, there are two minor areas in generator.py that can be improved to better adhere to software engineering best practices.
Your task is to refactor generator.py and the CI/CD workflow based on the following precise specifications.
æŠ€è¡“ä»•æ§˜1ï¼šãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¤‡æ’é™¤ (Adherence to DRY Principle)
Objective:
Eliminate the redundant data transformation logic in generator.py. The single source of truth for data structures is models.py, and we must reuse it.
Problem: generator.py currently re-implements the logic to determine the stage and format the data for the frontend. This violates the DRY (Don't Repeat Yourself) principle. If we change the logic in models.py in the future, we would have to remember to change it in generator.py as well, which is error-prone.
Solution: generator.py must deserialize the JSON data back into a list of EnrichedTrendItem objects and then call the existing to_dict_for_frontend() method.
scripts/generator.py ã®ä¿®æ­£:

# scripts/generator.py
import json
import os
import shutil
import sys
from jinja2 import Environment, FileSystemLoader
from models import EnrichedTrendItem # â˜… 1. Import the dataclass

def generate_site_from_cache():
    """Reads data from the cache and generates all static site artifacts."""
    print("[INFO] Starting DEPLOYER pipeline...")
    
    # ... (Path setup is the same) ...
    
    # 2. Load and Deserialize data from cache
    cache_path = os.path.join(cache_dir, 'latest_trends.json')
    try:
        with open(cache_path, 'r', encoding='utf-8') as f:
            # â˜… 2. Deserialize JSON dicts into EnrichedTrendItem objects
            full_trends_data = [EnrichedTrendItem(**item) for item in json.load(f)]
            print(f"Loaded and deserialized {len(full_trends_data)} trends from cache.")
    except (FileNotFoundError, json.JSONDecodeError, TypeError) as e:
        print(f"[CRITICAL] Failed to load or deserialize cache file '{cache_path}'. Halting. Error: {e}", file=sys.stderr)
        sys.exit(1)

    # 3. Prepare dist directory
    # ... (Same as before) ...
    
    # â˜… 4. Transform data for frontend using the single source of truth
    # The redundant logic is now removed.
    frontend_trends = [item.to_dict_for_frontend() for item in full_trends_data]

    # 5. Save frontend data
    # ... (Same as before) ...

    # ... (The rest of the file remains the same)

æŠ€è¡“ä»•æ§˜2ï¼šé™çš„ã‚¢ã‚»ãƒƒãƒˆã®ç®¡ç†æ–¹æ³•ã®ãƒ¢ãƒ€ãƒ³åŒ–
Objective:
Separate the concern of copying static assets from the Python script and delegate it to a more appropriate tool within the CI/CD workflow.
Problem: generator.py currently contains logic (shutil.copytree) to copy the static/ directory. While functional, this mixes Python's data processing role with a simple file operation task that is better handled by the workflow itself.
Solution: Remove the file-copying logic from Python and use a standard shell command (cp) within the deploy.yml workflow.
scripts/generator.py ã®ä¿®æ­£:

# scripts/generator.py
# ... in generate_site_from_cache():
    # ...
    # 6. Copy static assets  <- â˜… REMOVE THIS ENTIRE BLOCK
    # if os.path.exists(static_dir):
    #     shutil.copytree(static_dir, os.path.join(dist_dir, 'static'))
    #     print("Copied static assets.")
    # else:
    #     print("Warning: static directory not found.")
    # ...

.github/workflows/deploy.yml ã®ä¿®æ­£:

# .github/workflows/deploy.yml
# ... in build-and-deploy job:
      # ...
      - name: ğŸ—ï¸ Generate Static Site
        run: python scripts/generator.py
      
      - name: ğŸ“‚ Copy Static Assets
        # â˜… ADD THIS NEW STEP
        run: cp -r static dist/

      - name: ğŸš€ Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        # Note: The 'actions/deploy-pages' action might need configuration
        # to know that it should deploy the 'dist' folder.
        # This is usually handled by a 'actions/upload-pages-artifact' step before.
        # Let's refine this part as well.

deploy.yml ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã®æœ€çµ‚çš„ãªæ´—ç·´:
For the most robust GitHub Pages deployment, we should use the upload-pages-artifact and deploy-pages actions together.

# .github/workflows/deploy.yml
# ...
    jobs:
      build-and-deploy:
        # ...
        steps:
          # ... (checkout, setup python, etc.)
          - name: ğŸ—ï¸ Generate Site Logic
            run: python scripts/generator.py
          
          - name: ğŸ“‚ Copy Static Assets
            run: cp -r static dist/

          - name: ğŸ“¦ Upload artifact
            uses: actions/upload-pages-artifact@v3
            with:
              path: './dist'

      deploy:
        needs: build-and-deploy
        permissions:
          pages: write
          id-token: write
        environment:
          name: github-pages
          url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        steps:
          - name: ğŸš€ Deploy to GitHub Pages
            id: deployment
            uses: actions/deploy-pages@v4

Final Instruction:
Please generate an implementation_plan.md for these two refactoring tasks. The goal is to make our generator.py script cleaner and more focused, while making our CI/CD workflow more explicit and robust. I will approve the plan before you proceed.