name: Fetch and Cache Trend Data

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'models.py'
      - 'requirements.txt'
      - '.github/workflows/fetcher.yml'

jobs:
  fetch-and-cache:
    runs-on: ubuntu-latest
    # Dockerã‚³ãƒ³ãƒ†ãƒŠã®åˆ©ç”¨ã¯ç¶­æŒã™ã‚‹
    container:
      image: mcr.microsoft.com/playwright/python:v1.44.0-jammy

    steps:
      - name: Checkout main branch for scripts
        uses: actions/checkout@v4
      
      # â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
      # â˜… å¤‰æ›´ç‚¹ â˜…
      # â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
      - name: ğŸ”¬ Debugging: Verify Environment and Dependencies
        run: |
          echo "--- Verifying Python and Pip ---"
          which python
          python --version
          which pip
          pip --version
          
          echo "\n--- Installing Dependencies with Verbose Output ---"
          # -v ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã€pipãŒä½•ã‚’ã—ã¦ã„ã‚‹ã‹ã‚’è©³ç´°ã«å‡ºåŠ›ã•ã›ã‚‹
          pip install -v -r requirements.txt
          
          echo "\n--- Verifying Installed Playwright ---"
          pip show playwright
          
          echo "\n--- Verifying Pre-installed Browsers ---"
          # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´æ‰€ã‚’ç¢ºèªã™ã‚‹
          ls -lR /ms-playwright/

      - name: ğŸ“¥ Restore scores cache
        id: scores-cache-restore
        uses: actions/cache/restore@v4
        with:
          path: cache/previous_scores.json
          key: scores-cache-v1

      - name: ğŸ Run Data Pipeline
        env:
          MERCARI_AFFILIATE_ID: ${{ secrets.MERCARI_AFFILIATE_ID }}
          GA4_TRACKING_ID: ${{ secrets.GA4_TRACKING_ID }}
        run: python scripts/main.py

      # ... (ä»¥é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã¨Gitãƒ—ãƒƒã‚·ãƒ¥ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å¤‰æ›´ãªã—)
      - name: ğŸ’¾ Save current scores to cache for next run
        # ...
      - name: ğŸš€ Commit and Push data to cache-branch
        # ...